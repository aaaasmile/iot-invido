== iot-invido
Questo service serve per ricevere dati dai miei dispositivi iot.
Per esempio i dati letti dal  sensore BME680 sul ESP8266. Vedi il progetto GasTempBME680.

Per stoppare il sevice si usa:
sudo systemctl stop iot-invido

== Deployment su ubuntu direttamente
git pull --all
./publish-iot.sh

== Deployment dettagli e preparazione
Certbot va fatto alla fine, altrimenti ti cambia il file default e si ha un conflitto di siti già definiti.
Configurazione del dominio iot.invido.it sul dns di aruba.

Creare la struttura dell'applicazione
~/app/go/iot-invido/current
~/app/go/iot-invido/old
~/app/go/iot-invido/zips
In ~/build/ invece si fa il clone della repository iot-invido
Qui si compila deploy.bin e si copia update-service.sh in ~/app/go/iot-invido/
Poi si lancia ./publish-iot.sh

Ora bisogna abilitare il service:
sudo systemctl enable iot-invido.service
Ora si fa partire il service (resistente al reboot):
sudo systemctl start iot-invido
Per vedere i logs si usa:
sudo journalctl -f -u iot-invido

Per ultimo si setta nginx
cd /etc/nginx/sites-available
sudo cp live.invido.it  iot.invido.it
poi cambio i link http e il nome del server usando i dati del nuovo service iot-invido con:
sudo nano iot.invido.it
Una verifica della configuraione con 
sudo nginx -t
Se ci sono dei warning, cancellare il file e ripetere di nuovo fino a quando è tutto ok.
Per esempio ho avuto il problema che, facendo l'update di certbot prima di settare nginx,
certbot mi ha messo iot.invido.it nel file die default, in quanto non era configurato.

Ora manca l'enable:
sudo ln -s /etc/nginx/sites-available/iot.invido.it  /etc/nginx/sites-enabled/iot.invido.it
Ricevo dei warning sulla porta 443, che non dovrebbero causare problemi. Ora il restart:
sudo systemctl restart nginx


== Service Config
Questo il conetnuto del file che compare con:
sudo nano /lib/systemd/system/iot-invido.service
Poi si fa l'enable:
sudo systemctl enable iot-invido.service
E infine lo start:
sudo systemctl start iot-invido
Logs sono disponibili con:
sudo journalctl -f -u iot-invido

Qui segue il contenuto del file iot-invido.service
Nota il Type=idle che è meglio di simple in quanto così 
viene fatto partire quando anche la wlan ha ottenuto l'IP intranet
per consentire l'accesso.

-------------------------------- file content
[Install]
WantedBy=multi-user.target

[Unit]
Description=iot-invido service
ConditionPathExists=/home/igor/app/go/iot-invido/current/iot-invido.bin
After=network.target

[Service]
Type=idle
User=igor
Group=igor
LimitNOFILE=1024

Restart=on-failure
RestartSec=10
startLimitIntervalSec=60

WorkingDirectory=/home/igor/app/go/iot-invido/current/
ExecStart=/home/igor/app/go/iot-invido/current/iot-invido.bin

# make sure log directory exists and owned by syslog
PermissionsStartOnly=true
ExecStartPre=/bin/mkdir -p /var/log/iot-invido
ExecStartPre=/bin/chown igor:igor /var/log/iot-invido
ExecStartPre=/bin/chmod 755 /var/log/iot-invido
StandardOutput=syslog
StandardError=syslog

------------------------------------------- end file content

go mod init github.com/aaaasmile/iot-invido